
<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Piano Dieta Settimanale</title>

<style>
  :root{
    --bg:#0b1021;--panel:#0f172a;--card:#0b1220;--muted:#94a3b8;--text:#e5e7eb;
    --pri:#22d3ee;--acc:#a78bfa;--ok:#34d399;--warn:#f59e0b;--danger:#ef4444;
    --brd:rgba(255,255,255,.08)
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    background:linear-gradient(135deg,#0b1021,#111827 40%,#0b1021);color:var(--text)
  }
  header{
    padding:16px;border-bottom:1px solid var(--brd);
    background:rgba(15,23,42,.7);backdrop-filter:blur(6px)
  }
  header h1{margin:0;font-size:clamp(18px,3.6vw,26px)}
  header p{margin:4px 0 0;color:var(--muted)}

  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:12px 14px}
  .tab-btn{
    padding:10px 14px;border:1px solid var(--brd);border-radius:12px;
    background:#0b1220;color:var(--text);cursor:pointer;font-weight:600
  }
  .tab-btn.active{background:linear-gradient(135deg,var(--pri),var(--acc));color:#0b1220;border:none}
  .page{display:none;max-width:1200px;margin:0 auto;padding:14px}
  .page.active{display:block}
  .panel{background:rgba(2,6,23,.55);border:1px solid var(--brd);border-radius:14px;padding:12px}
  .sec{margin-bottom:12px}
  .sec h3{margin:0 0 8px;font-size:15px;color:#dbeafe}

  /* Inputs/base */
  input,select,button,textarea{
    border-radius:10px;border:1px solid var(--brd);background:#0b1220;color:var(--text);
    padding:8px 10px;outline:none;min-width:0
  }
  input:focus,select:focus,textarea:focus{border-color:var(--pri);box-shadow:0 0 0 3px rgba(34,211,238,.18)}
  button{cursor:pointer;font-weight:600}
  .btn{background:linear-gradient(135deg,var(--pri),var(--acc));border:none;color:#0b1220}
  .secondary{background:#0b1220;color:var(--text);border:1px solid var(--brd)}
  .danger{border-color:#b91c1c;color:#fee2e2}
  .row{display:grid;gap:8px}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:repeat(3,1fr)}
  .four{grid-template-columns:repeat(4,1fr)}
  .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .right{justify-content:flex-end}

  .badge{padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid var(--brd);background:#0b1220;color:#94a3b8}
  .tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--brd)}
  .tag.c{color:#0ea5e9;background:rgba(14,165,233,.15)}
  .tag.p{color:#22c55e;background:rgba(34,197,94,.15)}
  .tag.f{color:#f59e0b;background:rgba(245,158,11,.15)}

  .list{display:grid;gap:8px;max-height:calc(100vh - 280px);overflow:auto;
        border:1px solid var(--brd);padding:8px;border-radius:12px;background:rgba(2,6,23,.3)}
  .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;
        padding:8px;border:1px solid var(--brd);border-radius:12px;background:rgba(11,18,32,.6)}
  .item .meta{color:var(--muted);font-size:12px}

  .grid{display:grid;gap:10px}
  .meal{border:1px solid var(--brd);border-radius:14px;padding:10px;background:rgba(2,6,23,.45)}
  .meal h4{margin:0 0 8px}
  .macro-box{display:grid;gap:6px;grid-template-columns:repeat(3,1fr)}
  .macro{border:1px dashed rgba(255,255,255,.15);border-radius:10px;padding:8px}
  .macro h5{margin:0 0 6px;font-size:13px}

  .muted{color:var(--muted);font-size:12px}
  .unit{color:#cbd5e1;font-size:12px;border:1px solid var(--brd);padding:2px 6px;border-radius:999px;background:#0b1220}

  /* Hint + campo attivo */
  .hintbar{
    margin-top:6px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);
    background:linear-gradient(135deg,rgba(34,211,238,.12),rgba(167,139,250,.12));
    color:#e2e8f0;font-size:13px
  }
  .hl{border-color:var(--pri)!important;box-shadow:0 0 0 3px rgba(34,211,238,.18)!important}

  /* Gruppi alimenti (accordion) */
  .group { border:1px solid var(--brd); border-radius:12px; margin:10px 0; background:rgba(2,6,23,.35); }
  .group-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; cursor:pointer; user-select:none; }
  .group-header:hover { background:rgba(255,255,255,.03); }
  .group-title { display:flex; align-items:center; gap:8px; font-weight:700; }
  .group-title .tag { font-weight:700 }
  .group-count { color:var(--muted); font-size:12px }
  .group-actions { display:flex; gap:8px }
  .group-body { padding:8px; border-top:1px solid var(--brd); }
  .hidden { display:none !important; }

  /* Percentuali: validazione */
  .totals-bar{display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--brd);font-size:12px}
  .ok{color:#10b981;background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3)}
  .err{color:#ef4444;background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.3)}
  .input-err{border-color:#ef4444!important; box-shadow:0 0 0 3px rgba(239,68,68,.18)!important}

  /* Arrotondamento info */
  .approx-badge{font-size:10px;border:1px dashed rgba(255,255,255,.25);padding:2px 6px;border-radius:999px}
  .approx-up{color:#fde68a;background:rgba(253,230,138,.12)}
  .approx-down{color:#93c5fd;background:rgba(147,197,253,.12)}
  .auto-badge{font-size:10px;border:1px solid rgba(255,255,255,.25);padding:2px 6px;border-radius:999px;background:rgba(34,197,94,.12);color:#34d399}

  /* Varianti (Anteprima/PDF) */
  .var-badge{padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid var(--brd)}
  .var0{background:#1e3a8a33;color:#93c5fd;border-color:#1e3a8a55}
  .var1{background:#065f4633;color:#86efac;border-color:#065f4655}
  .var2{background:#7c2d1233;color:#fca5a5;border-color:#7c2d1255}
  .var3{background:#6b21a833;color:#d8b4fe;border-color:#6b21a855}
  .var4{background:#b4530933;color:#fcd34d;border-color:#b4530955}
  .var5{background:#0f766e33;color:#99f6e4;border-color:#0f766e55}
  .var-box{border:1px solid var(--brd);border-radius:12px;padding:8px;margin-top:8px}
  .var-title{display:flex;align-items:center;gap:8px;margin:0 0 6px 0}

  @media (max-width:980px){
    .two,.three,.four{grid-template-columns:1fr}
    .macro-box{grid-template-columns:1fr}
    .tabs{position:sticky;top:0;z-index:5;background:rgba(11,18,32,.9);backdrop-filter:blur(6px)}
    .list{max-height:50vh}
  }
  /* Stampa solo Anteprima */
  @media print{
    header,.tabs,.page:not(#page-preview),.noprint{display:none!important}
    body{background:#fff;color:#000}
    .panel{border:none;background:#fff}
    .meal{page-break-inside:avoid}
  }
</style>
</head>
<body>
<noscript style="padding:12px;display:block;background:#fee2e2;color:#111">
  Per usare questa app serve JavaScript attivo nel browser.
</noscript>

<header>
  <h1>Piano Dieta Settimanale</h1>
  <p>Schede: Planner - Impostazioni - Alimenti - Anteprima</p>
</header>

<nav class="tabs noprint">
  <button class="tab-btn active" data-tab="page-planner">Planner</button>
  <button class="tab-btn" data-tab="page-settings">Impostazioni</button>
  <button class="tab-btn" data-tab="page-foods">Alimenti</button>
  <button class="tab-btn" data-tab="page-preview">Anteprima</button>
</nav>

<!-- PLANNER -->
<section id="page-planner" class="page active">
  <div class="panel">
    <div class="sec">
      <h3>Planner Pasti Giornalieri</h3>
      <div id="mealsContainer" class="grid"></div>
    </div>

    <div class="sec">
      <div class="inline" style="justify-content:space-between">
        <h3>Riepilogo giornaliero</h3>
        <span class="badge" id="dailySummary"></span>
      </div>
      <div id="warnings" class="muted"></div>
    </div>

    <div class="sec">
      <h3>Calorie per macro</h3>
      <div class="inline">
        <span class="tag c">Carbo 4 kcal/g</span>
        <span class="tag p">Proteine 4 kcal/g</span>
        <span class="tag f">Grassi 9 kcal/g</span>
      </div>
    </div>
  </div>
</section>

<!-- SETTINGS -->
<section id="page-settings" class="page">
  <div class="panel">

    <!-- ‚úÖ SEZIONE LOGIN INSERITA -->
    <div class="sec">
      <h3>Account (Email/Password) &amp; Sync</h3>

      <div class="row two">
        <input id="email" type="email" placeholder="Email" />
        <input id="password" type="password" placeholder="Password" />
      </div>

      <div class="row three" style="margin-top:6px">
        <button class="btn" id="loginBtn">Login</button>
        <button class="secondary" id="registerBtn">Crea account</button>
        <button class="secondary danger" id="logoutBtn">Logout</button>
      </div>

      <div class="muted" id="syncStatus" style="margin-top:6px"></div>
    </div>

    <div class="sec">
      <h3>Profilo</h3>
      <div class="row two">
        <select id="profileSelect"></select>
        <button class="btn" id="addProfileBtn">Nuovo</button>
      </div>
      <div class="row two" style="margin-top:6px">
        <button class="secondary" id="renameProfileBtn">Rinomina</button>
        <button class="secondary" id="delProfileBtn">Elimina</button>
      </div>
      <div class="row two" style="margin-top:6px">
        <button class="secondary" id="exportProfileBtn" title="Scarica JSON profilo">Esporta</button>
        <button class="secondary" id="importProfileBtn" title="Carica JSON profilo">Importa</button>
        <input type="file" id="profileFile" accept="application/json" style="display:none">
      </div>
    </div>

    <div class="sec">
      <h3>Fase e target</h3>
      <div class="row two">
        <div class="inline">
          <select id="phase">
            <option value="bulk">Bulk</option>
            <option value="cut">Cut</option>
          </select>
        </div>
        <div class="inline">
          <input id="weight" type="number" min="30" step="0.1" placeholder="Peso">
          <span class="unit">kg</span>
        </div>
      </div>
      <div class="row two" style="margin-top:6px">
        <div class="inline">
          <input id="kcalTarget" type="number" min="800" step="10" placeholder="Kcal al giorno">
          <span class="unit">kcal/die</span>
        </div>
        <select id="macroMode">
          <option value="auto">Calcolo automatico</option>
          <option value="manual">Inserimento manuale</option>
        </select>
      </div>
      <div class="row three" style="margin-top:6px">
        <div class="inline"><input id="carbDay" type="number" step="1" placeholder="Carbo"><span class="unit">g/die</span></div>
        <div class="inline"><input id="protDay" type="number" step="1" placeholder="Proteine"><span class="unit">g/die</span></div>
        <div class="inline"><input id="fatDay"  type="number" step="1" placeholder="Grassi"><span class="unit">g/die</span></div>
      </div>
      <div class="muted" id="macroHint" style="margin-top:6px"></div>
    </div>

    <!-- Moltiplicatori g/kg -->
    <div class="sec">
      <h3>Moltiplicatori g/kg (per calcolo automatico)</h3>
      <div class="row two">
        <div class="panel" style="padding:10px">
          <div class="inline"><strong>Bulk</strong><span class="tag">default P 1.6, F 1.0</span></div>
          <div class="row two" style="margin-top:6px">
            <div class="inline"><input id="bulkProt" type="number" step="0.1" min="0" placeholder="Proteine"><span class="unit">g/kg</span></div>
            <div class="inline"><input id="bulkFat"  type="number" step="0.1" min="0" placeholder="Grassi"><span class="unit">g/kg</span></div>
          </div>
        </div>
        <div class="panel" style="padding:10px">
          <div class="inline"><strong>Cut</strong><span class="tag">default P 2.2, F 0.8</span></div>
          <div class="row two" style="margin-top:6px">
            <div class="inline"><input id="cutProt" type="number" step="0.1" min="0" placeholder="Proteine"><span class="unit">g/kg</span></div>
            <div class="inline"><input id="cutFat"  type="number" step="0.1" min="0" placeholder="Grassi"><span class="unit">g/kg</span></div>
          </div>
        </div>
      </div>
      <div class="row two" style="margin-top:6px">
        <button class="secondary" id="resetFactorsBtn">Ripristina default</button>
        <span class="muted">Se modalit√† = Calcolo automatico, i nuovi fattori si applicano subito.</span>
      </div>
      <div id="factorFieldHint" class="hintbar"></div>
    </div>

    <!-- Distribuzione -->
    <div class="sec">
      <h3>Pasti</h3>
      <div class="row two">
        <input id="mealsCount" type="number" min="1" max="10" value="3" />
        <select id="splitMode">
          <option value="percent">Distribuzione per %</option>
          <option value="manual">Manuale (g per pasto)</option>
        </select>
      </div>
      <div id="percentages" class="row" style="margin-top:6px"></div>
      <div class="row two" style="margin-top:6px">
        <button class="btn" id="applySplitBtn" disabled>Applica distribuzione</button>
        <button class="secondary" id="resetMealsBtn">Reimposta pasti</button>
      </div>
    </div>

    <!-- Interfaccia globale -->
    <div class="sec">
      <h3>Interfaccia</h3>
      <div class="row two">
        <label class="inline">
          <input type="checkbox" id="toggleHints"/>
          <span>Mostra suggerimenti (hints) in Planner e Alimenti</span>
        </label>
        <label class="inline">
          <input type="checkbox" id="snapManual5"/>
          <span>Aggancia i grammi inseriti manualmente a multipli di 5 g</span>
        </label>
      </div>
    </div>

    <!-- Anteprima / PDF -->
    <div class="sec">
      <h3>Anteprima / PDF</h3>
      <div class="row four">
        <label class="inline"><input type="checkbox" id="showColC" checked/> <span>Mostra Carboidrati (C)</span></label>
        <label class="inline"><input type="checkbox" id="showColP" checked/> <span>Mostra Proteine (P)</span></label>
        <label class="inline"><input type="checkbox" id="showColF" checked/> <span>Mostra Grassi (G)</span></label>
        <label class="inline"><input type="checkbox" id="showTargets" checked/> <span>Mostra target del pasto</span></label>
      </div>
      <div class="muted" style="margin-top:6px">
        Le preferenze sono globali e si applicano sia alla scheda Anteprima che al PDF.
      </div>
    </div>

  </div>
</section>

<!-- FOODS -->
<section id="page-foods" class="page">
  <div class="panel">
    <div class="sec">
      <h3>Alimenti</h3>
      <div class="row">
        <input id="foodSearch" placeholder="Cerca alimento...">

        <div class="row three">
          <input id="fName" placeholder="Nome">
          <input id="fKcal" type="number" step="0.1" placeholder="Energia (kcal/100g)">
          <input id="fCarb" type="number" step="0.1" placeholder="Carbo (g/100g)">
          <input id="fProt" type="number" step="0.1" placeholder="Proteine (g/100g)">
          <input id="fFat"  type="number" step="0.1" placeholder="Grassi (g/100g)">
          <button class="btn" id="addFoodBtn">Aggiungi/Salva</button>
        </div>

        <div id="foodFieldHint" class="hintbar"></div>
        <div id="foodMacroPreview" class="inline" style="margin-top:6px">
          <span>Dominante:</span>
          <span id="foodDominant" class="tag">-</span>
          <span class="muted" id="foodMacroLine">C 0 g - P 0 g - G 0 g</span>
          <span class="muted" id="foodKcalEst"></span>
        </div>

        <div class="inline right noprint" style="margin-top:4px">
          <button class="secondary" id="exportFoodsBtn">Esporta alimenti</button>
          <button class="secondary" id="importFoodsBtn">Importa alimenti</button>
          <input type="file" id="foodsFile" accept=".json,.csv" style="display:none">
        </div>
        <div class="inline right noprint" style="margin-top:4px">
          <button class="secondary" id="collapseAllBtn">Comprimi tutti</button>
          <button class="secondary" id="expandAllBtn">Espandi tutti</button>
        </div>

        <div id="foodsGroups"></div>
      </div>
    </div>
  </div>
</section>

<!-- PREVIEW -->
<section id="page-preview" class="page">
  <div class="panel">
    <div class="sec">
      <h3>Anteprima esportazione</h3>
      <div class="inline" style="justify-content:space-between">
        <div class="inline">
          <span class="muted">Legenda tipi pasto:</span>
          <span class="var-badge var0">Tipo 1</span>
          <span class="var-badge var1">Tipo 2</span>
          <span class="var-badge var2">Tipo 3</span>
          <span class="var-badge var3">Tipo 4</span>
          <span class="var-badge var4">Tipo 5</span>
          <span class="var-badge var5">Tipo 6</span>
        </div>
        <button class="btn" id="previewExportBtn">Esporta PDF</button>
      </div>
    </div>
    <div id="previewContainer"></div>
  </div>
</section>

<script type="module">
/* ================================
   Firebase (Auth + Firestore)
   ================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  onSnapshot,
  enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDf5y-wlgT4gylL4d_cMQe_ik8s_S09VRc",
  authDomain: "programma-dieta-952d7.firebaseapp.com",
  projectId: "programma-dieta-952d7",
  storageBucket: "programma-dieta-952d7.firebasestorage.app",
  messagingSenderId: "16575395211",
  appId: "1:16575395211:web:f96fe4db36fcc85cf96b8e",
  measurementId: "G-17Q7WZDRQ0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(() => {});

// Flag bootstrap: evita che lo stato locale "vinca" sul cloud appena apri la pagina
let BOOTING = true;

/* ========= Polyfill ========= */
if (!('crypto' in window) || !crypto.randomUUID){
  window.crypto = window.crypto || {};
  crypto.randomUUID = () => 'id-' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
}

/* ========= Utils ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt  = n => (Math.round(n*10)/10).toString().replace('.', ','); // 1 dec
const fmt0 = n => String(Math.round(n)); // intero
const parse = v => isNaN(parseFloat(v))?0:parseFloat(v);
const KCAL_C=4, KCAL_P=4, KCAL_F=9;

/* ========= Storage ========= */
const KEY = 'diet-planner-v1';
let state = load() || seed();
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch{ return null; } }

/** ‚úÖ SAVE CORRETTA (prima era spezzata) */
function save(){
  // Durante bootstrap: non aggiorniamo updatedAt e non sync
  if (BOOTING){
    localStorage.setItem(KEY, JSON.stringify(state));
    return;
  }
  state._meta = state._meta || {};
  state._meta.updatedAt = Date.now();
  localStorage.setItem(KEY, JSON.stringify(state));
  scheduleRemoteSave();
}

/* ========= Cloud Sync (per utente) ========= */
let remote = {
  uid: null,
  unsub: null,
  applyingRemote: false,
  saveTimer: null,
};

function setSyncStatus(msg){
  if (els?.syncStatus) els.syncStatus.textContent = msg;
}

function userDocRef(uid){
  return doc(db, 'users', uid, 'apps', 'dietPlanner');
}

async function pushStateToCloud(){
  if(!remote.uid) return;
  const ref = userDocRef(remote.uid);
  try {
    await setDoc(ref, { state }, { merge: true });
    setSyncStatus('‚úÖ Salvato sul cloud (' + new Date().toLocaleTimeString() + ')');
  } catch (e) {
    console.error('[SYNC] setDoc error:', e);
    setSyncStatus('‚ùå Errore sync: ' + (e.code || e.message));
  }
}

function scheduleRemoteSave(){
  if(!remote.uid) return;
  if(remote.applyingRemote) return;
  clearTimeout(remote.saveTimer);
  remote.saveTimer = setTimeout(() => {
    pushStateToCloud().catch(console.error);
  }, 600);
}

async function startCloudSync(uid){
  remote.uid = uid;
  const ref = userDocRef(uid);

  const snap = await getDoc(ref);
  const localTs = state?._meta?.updatedAt || 0;

  if(snap.exists()){
    const cloudState = snap.data().state;
    const cloudTs = cloudState?._meta?.updatedAt || 0;

    if(cloudTs > localTs){
      // Cloud pi√π nuovo -> ripristina
      remote.applyingRemote = true;
      state = cloudState;
      localStorage.setItem(KEY, JSON.stringify(state));
      initProfileUI();
      remote.applyingRemote = false;
      setSyncStatus('‚úÖ Ripristinato dal cloud (' + new Date().toLocaleTimeString() + ')');
    } else if(localTs > cloudTs){
      // Locale pi√π nuovo -> push (offline use-case)
      await pushStateToCloud();
    } else {
      setSyncStatus('‚ÑπÔ∏è In sync');
    }
  } else {
    // Se non esiste -> pubblichiamo lo state locale
    await pushStateToCloud();
  }

  if(remote.unsub) remote.unsub();
  remote.unsub = onSnapshot(ref, (docSnap) => {
    if(!docSnap.exists()) return;

    const cloudState = docSnap.data().state;
    const cloudTs = cloudState?._meta?.updatedAt || 0;
    const localTs2 = state?._meta?.updatedAt || 0;

    if(cloudTs > localTs2){
      remote.applyingRemote = true;
      state = cloudState;
      localStorage.setItem(KEY, JSON.stringify(state));
      initProfileUI();
      remote.applyingRemote = false;
      setSyncStatus('‚úÖ Aggiornato dal cloud (' + new Date().toLocaleTimeString() + ')');
    }
  }, (err) => {
    console.error('[SYNC] onSnapshot error:', err);
    setSyncStatus('‚ùå Listener sync: ' + (err.code || err.message));
  });
}

/* ========= Dataset base ========= */
function dominant(c,p,f){ const arr=[{k:'c',v:c},{k:'p',v:p},{k:'f',v:f}]; arr.sort((a,b)=>b.v-a.v); return arr[0].k; }
function F(name,kcal,c,p,fat){
  const id = crypto.randomUUID();
  return {id,name,kcal,c,p,fat,group:dominant(c,p,fat)};
}
const CURATED_VERSION = '1.2';
const CURATED_FOODS = [
  F('Riso bianco crudo', 360, 79, 7, 0.6), F('Riso basmati crudo', 356, 78, 8, 0.8),
  F('Pasta secca cruda', 353, 72, 13, 1.5), F('Fiocchi di avena', 371, 59, 13, 7),
  F('Quinoa cruda', 368, 64, 14, 6), F('Farro perlato crudo', 335, 67, 15, 2),
  F('Orzo perlato crudo', 354, 77, 10, 1.2), F('Riso bianco cotto', 130, 28, 2.7, 0.3),
  F('Pasta cotta', 131, 25, 5, 1.1), F('Patate lesse', 87, 20, 1.9, 0.1),
  F('Patate dolci cotte', 90, 21, 2, 0.2), F('Lenticchie cotte', 116, 20, 9, 0.4),
  F('Ceci cotti', 164, 27.4, 8.9, 2.6), F('Fagioli borlotti cotti', 127, 22.8, 8.7, 0.5),
  F('Fagioli neri cotti', 132, 23.7, 8.9, 0.5), F('Piselli cotti', 84, 15, 5.4, 0.2),
  F('Petto di pollo', 120, 0, 23, 2.6), F('Fesa di tacchino', 114, 0, 24, 1),
  F('Manzo magro (5% grasso)', 137, 0, 20, 6), F('Lonza di maiale', 143, 0, 21, 6),
  F('Merluzzo', 82, 0, 18, 0.7), F('Salmone atlantico', 208, 0, 20, 13),
  F('Tonno fresco', 144, 0, 23, 4.9), F('Uova intere', 143, 0.7, 12.6, 10.6),
  F('Albume', 52, 0.7, 10.9, 0.2), F('Yogurt greco 0%', 59, 3.6, 10, 0.4),
  F('Latte scremato', 34, 5, 3.4, 0.1), F('Olio extravergine di oliva', 884, 0, 0, 100),
  F('Avocado', 160, 9, 2, 15), F('Mandorle', 579, 21.6, 21.2, 49.9),
  F('Noci', 654, 13.7, 15.2, 65.2), F('Nocciole', 628, 16.7, 15, 60.8),
  F('Pistacchi', 560, 28, 20, 45), F('Anacardi', 553, 30, 18, 44),
  F('Semi di chia', 486, 42, 16, 31), F('Semi di lino', 534, 29, 18, 42),
  F('Semi di zucca', 559, 11, 30, 49), F('Banana', 89, 23, 1.1, 0.3),
  F('Mela', 52, 14, 0.3, 0.2), F('Arancia', 47, 12, 0.9, 0.1),
  F('Pera', 57, 15, 0.4, 0.1), F('Fragole', 32, 7.7, 0.7, 0.3),
  F('Mirtilli', 57, 14, 0.7, 0.3), F('Kiwi', 61, 15, 1.1, 0.5),
  F('Spinaci', 23, 3.6, 2.9, 0.4), F('Broccoli', 34, 7, 2.8, 0.4),
  F('Zucchine', 17, 3.1, 1.2, 0.3), F('Pomodori', 18, 3.9, 0.9, 0.2),
  F('Carote', 41, 10, 0.9, 0.2), F('Peperoni rossi', 31, 6, 1, 0.3),
  F('Melanzane', 25, 6, 1, 0.2), F('Lattuga', 15, 2.9, 1.4, 0.2),
  F('Pane integrale', 247, 41, 8.5, 2.5)
];

/* ========= Stato ========= */
function makeProfile(name){
  return {
    id: crypto.randomUUID(), name,
    phase:'bulk', weight:70, kcalTarget:2400, macroMode:'auto',
    macros:{c:0,p:0,f:0},
    mealsCount:3, splitMode:'percent',
    percentages:[],
    meals:[],
    factors:{ bulk:{p:1.6,f:1.0}, cut:{p:2.2,f:0.8} }
  };
}
function seed(){
  const profile = makeProfile('Profilo 1');
  return {
    _meta: { updatedAt: 0 },
    foods: [],
    foodsVersion: null,
    profiles:[profile],
    currentProfileId: profile.id,
    ui:{ showHints:true, foodsCollapsed:{c:false,p:false,f:false}, snapManual5:false, preview:{showC:true,showP:true,showF:true,showTargets:true} }
  };
}
function currentProfile(){ return state.profiles.find(p=>p.id===state.currentProfileId); }

/* ========= Elementi ========= */
const els = {
  previewContainer: $('#previewContainer'), previewExportBtn: $('#previewExportBtn'),
  mealsContainer: $('#mealsContainer'), dailySummary: $('#dailySummary'), warnings: $('#warnings'),
  profileSelect: $('#profileSelect'), addProfileBtn: $('#addProfileBtn'),
  renameProfileBtn: $('#renameProfileBtn'), delProfileBtn: $('#delProfileBtn'),
  exportProfileBtn: $('#exportProfileBtn'), importProfileBtn: $('#importProfileBtn'),
  profileFile: $('#profileFile'),
  phase: $('#phase'), weight: $('#weight'), kcalTarget: $('#kcalTarget'),
  macroMode: $('#macroMode'), carbDay: $('#carbDay'), protDay: $('#protDay'), fatDay: $('#fatDay'),
  macroHint: $('#macroHint'),
  mealsCount: $('#mealsCount'), splitMode: $('#splitMode'), percentages: $('#percentages'),
  applySplitBtn: $('#applySplitBtn'), resetMealsBtn: $('#resetMealsBtn'),
  toggleHints: $('#toggleHints'),
  bulkProt: $('#bulkProt'), bulkFat: $('#bulkFat'), cutProt: $('#cutProt'), cutFat: $('#cutFat'),
  resetFactorsBtn: $('#resetFactorsBtn'), factorFieldHint: $('#factorFieldHint'),
  snapManual5: $('#snapManual5'),
  showColC: $('#showColC'), showColP: $('#showColP'), showColF: $('#showColF'), showTargets: $('#showTargets'),
  foodSearch: $('#foodSearch'),
  fName: $('#fName'), fKcal: $('#fKcal'), fCarb: $('#fCarb'), fProt: $('#fProt'),
  fFat: $('#fFat'), addFoodBtn: $('#addFoodBtn'),
  foodsGroups: $('#foodsGroups'), exportFoodsBtn: $('#exportFoodsBtn'), importFoodsBtn: $('#importFoodsBtn'),
  foodsFile: $('#foodsFile'),
  collapseAllBtn: $('#collapseAllBtn'), expandAllBtn: $('#expandAllBtn'),
  foodDominant: $('#foodDominant'), foodMacroLine: $('#foodMacroLine'), foodKcalEst: $('#foodKcalEst'),
  foodFieldHint: $('#foodFieldHint'),

  // Auth
  email: $('#email'),
  password: $('#password'),
  loginBtn: $('#loginBtn'),
  registerBtn: $('#registerBtn'),
  logoutBtn: $('#logoutBtn'),
  syncStatus: $('#syncStatus'),
};

/* ========= Tabs ========= */
const tabButtons = $$('.tab-btn');
function setTab(id){
  $$('.page').forEach(p=>p.classList.toggle('active', p.id===id));
  tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  localStorage.setItem('diet-tab', id);
}
tabButtons.forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)));
const lastTab = localStorage.getItem('diet-tab');
if (lastTab) setTab(lastTab);

/* ========= Foods bootstrap ========= */
(function ensureCuratedFoods(){
  if (!state.ui) state.ui = {};
  if (typeof state.ui.showHints !== 'boolean') state.ui.showHints = true;
  if (!state.ui.foodsCollapsed) state.ui.foodsCollapsed = {c:false,p:false,f:false};
  if (typeof state.ui.snapManual5 !== 'boolean') state.ui.snapManual5 = false;
  if (!state.ui.preview) state.ui.preview = {showC:true,showP:true,showF:true,showTargets:true};
  if (!state.foodsVersion || state.foodsVersion !== CURATED_VERSION){
    state.foods = CURATED_FOODS.slice();
    state.foodsVersion = CURATED_VERSION;
    save();
  }
})();

/* ============================
   QUI CONTINUA IL TUO CODICE
   (renderFoods, planner, ecc.)
   ============================

   üî¥ NOTA IMPORTANTE:
   Ho accorciato la lista CURATED_FOODS per non duplicare migliaia di righe in chat.
   Devi reinserire nel file la TUA lista completa (quella che avevi gi√†),
   oppure lasciare quella completa gi√† presente nel tuo file originario.

   Se vuoi, incollami l‚Äôintero blocco CURATED_FOODS del tuo file e te lo reinserisco io.
*/

/* ========= Auth UI handlers ========= */
els.loginBtn?.addEventListener('click', async () => {
  try {
    await signInWithEmailAndPassword(auth, els.email.value.trim(), els.password.value);
  } catch (e) {
    alert('Login fallito: ' + e.message);
  }
});

els.registerBtn?.addEventListener('click', async () => {
  try {
    await createUserWithEmailAndPassword(auth, els.email.value.trim(), els.password.value);
  } catch (e) {
    alert('Registrazione fallita: ' + e.message);
  }
});

els.logoutBtn?.addEventListener('click', async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, (user) => {
  BOOTING = false;
  if (user) {
    setSyncStatus('üîÑ Connessione al cloud‚Ä¶');
    startCloudSync(user.uid).catch((e) => {
      console.error('[SYNC] startCloudSync error:', e);
      setSyncStatus('‚ùå Sync init: ' + (e.code || e.message));
    });
  } else {
    setSyncStatus('‚ÑπÔ∏è Sync disattivo: fai login per salvare sul cloud');
    if (remote.unsub) remote.unsub();
    remote.uid = null;
  }
});

// ‚úÖ Alla fine del bootstrap, comunque:
BOOTING = false;

</script>
</body>
</html>
